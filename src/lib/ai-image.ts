import { GoogleGenerativeAI } from '@google/generative-ai';

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || '');

export function isGeminiImageConfigured(): boolean {
  return !!process.env.GEMINI_API_KEY;
}

interface ImageGenerationInput {
  serviceName: string;
  description: string;
  whatYouDo: string;
  ownerName: string | null;
  reviewText: string;
  templateStyle: string;
  templateId: string;
  width: number;
  height: number;
  faceUrl?: string | null;
  logoUrl?: string | null;
}

function buildPromptForTemplate(input: ImageGenerationInput): string {
  const orientation = input.width > input.height ? '横長（landscape）' : '縦長（portrait）';

  // ミヤマ式プロンプト設計思想を応用した10種類のテンプレートデザイン
  // 原則：Attention（注意）→ Emotion（感情）→ Memory（記憶）→ Action（行動）
  // 構造：Pain（痛み提示）→ 認知逆転 → ベクトル提示 → 行動衝動
  const templateDesigns: Record<string, string> = {
    'tpl-000': `
■ビジュアルスタイル：モノクロ・コラージュ型（推薦ポスター）
コンセプト：モノクロ写真のコラージュ＋力強いタイポグラフィで「この人を推薦する」という権威と信頼を演出。

【カラーパレット（厳守）】
- 背景色：#111111（ほぼ黒）
- メイン文字色：#FFFFFF（白）
- アクセント色：#E8D44D（マスタードイエロー）
- サブ色：#CCCCCC（ライトグレー）
- カード背景：なし（テキスト直置き）

【グリッドシステム】
Swiss Styleの非対称グリッド。画像を不均等な4〜6ブロックに分割。
各ブロックの境界は白の細い罫線（1px）で区切る。

【レイアウト構成】
上部最大ブロック（画像の40%）：「この方を推薦します」をAkzidenz-Grotesk風の極太ゴシック体で配置。文字サイズはジャンプ率20倍（本文比）。色は#FFFFFF。文字は左揃え。
左中ブロック（画像の25%）：事業者の顔写真エリアを正方形で大きく配置。モノクロ処理風のプレースホルダー（シルエット）。周囲に白の細い枠線。
右中ブロック（画像の25%）：口コミ文を#FFFFFF で配置。フォントはゴシック体。行間は文字サイズの1.8倍。引用符「」を#E8D44D のアクセントで大きく装飾。
下部帯（画像の10%）：サービス名を#E8D44D で太字配置。★★★★★を#E8D44D で。ロゴエリアを右端に。

【タイポグラフィ】
見出し：Helvetica Neue Bold風の極太ゴシック。ジャンプ率20倍。
本文：Helvetica Neue Regular風のゴシック。行間1.8em。
装飾文字：背景に薄く（opacity 8%）大きな「RECOMMEND」の英字を斜めに配置。`,

    'tpl-001': `
■ビジュアルスタイル：アイソメトリック・イエロー型（口コミカード）
コンセプト：アイソメトリック（等角投影）のイラスト的構成＋黄色アクセントで親しみやすさと信頼感を両立。

【カラーパレット（厳守）】
- 背景色：#FFFFFF（白）
- メイン文字色：#1A1A1A（ほぼ黒）
- アクセント色：#FFD700（ゴールデンイエロー）
- サブ色：#F5F5F5（ライトグレー）
- カード背景：#F5F5F5
- ライン色：#E0E0E0

【グリッドシステム】
Bauhaus式の幾何学グリッド。整然とした左揃えレイアウト。

【レイアウト構成】
最上部（5%）：#FFD700 の太い水平ライン（高さ8px）。
ヘッダー（15%）：左にサービス名を極太ゴシック体で#1A1A1A。右にロゴエリア。
顔写真エリア（25%）：画像中央左に大きな丸型（直径は画像幅の28%）の顔写真プレースホルダー。周囲に#FFD700 の太い枠線（4px）。下に事業者名。
口コミカード（40%）：#F5F5F5 の角丸長方形カード。左端に#FFD700 の太いアクセントライン（幅6px）。カード内に口コミ文を#1A1A1A で配置。上部に★★★★★を#FFD700 で。
フッター（15%）：「お客様の声」の小見出しとサービス概要を#666666 で。下部に#FFD700 の細い水平ライン。

【タイポグラフィ】
見出し：DIN Pro Bold風の太いゴシック。ジャンプ率15倍。
本文：Noto Sans JP Regular。行間1.7em。レターsペーシング通常。
アクセント：★評価と引用符を#FFD700 で統一。`,

    'tpl-002': `
■ビジュアルスタイル：コラージュ・タイポグラフィ型（大見出しインパクト）
コンセプト：Swiss Style＋Bauhaus。原色（赤・青・黄）のカラーブロック＋力強いタイポグラフィでインパクトを最大化。

【カラーパレット（厳守）】
- 背景色：#FAFAFA（オフホワイト）
- メイン文字色：#111111（黒）
- アクセント色1：#E53935（鮮やかな赤）
- アクセント色2：#1565C0（深い青）
- アクセント色3：#FFD600（鮮やかな黄）
- カード背景：#FFFFFF

【グリッドシステム】
Swiss Style非対称グリッド。大胆な色面分割。
画像左端に#E53935 の太い縦帯（画像幅の8%）。
画像上端に#1565C0 の太い横帯（画像高さの5%）。

【レイアウト構成】
左の赤帯内：縦書きで「VOICE」を白文字で。
上の青帯内：サービス名を白文字で太く配置。
メインエリア上部（35%）：「お客様の声」を#111111 の超極太文字で配置。ジャンプ率25倍。一部の文字を#E53935 に色替え。
メインエリア中部左（25%）：顔写真エリアを正方形で。モノクロ風プレースホルダー。下に事業者名。
メインエリア中部右（25%）：口コミ文を#111111 で。#FFD600 の角丸ボックス内に配置。
メインエリア下部（15%）：★★★★★を#FFD600。サービス概要を#666666 で。ロゴエリアを右下に。

【タイポグラフィ】
見出し：Impact / Akzidenz-Grotesk風の超極太。ジャンプ率25倍。
本文：中太ゴシック体。行間1.6em。
色文字：見出しの一部を赤に変えてリズムを出す。`,

    'tpl-003': `
■ビジュアルスタイル：手書き水彩風型（口コミまとめ）
コンセプト：水彩画のにじみ＋手書き風フォントで温かみと親しみやすさを演出。女性向けサービスに最適。

【カラーパレット（厳守）】
- 背景色：#FFF8F0（クリームホワイト）
- メイン文字色：#4A3728（ダークブラウン）
- アクセント色：#E8927C（コーラルピンク）
- サブ色1：#A7C4A0（セージグリーン）
- サブ色2：#F0D9B5（ベージュ）
- 水彩にじみ：背景に薄いピンクとグリーンの水彩テクスチャ

【グリッドシステム】
有機的な非対称レイアウト。直線よりも曲線的な区切り。

【レイアウト構成】
背景：#FFF8F0 のベース上に、薄い水彩のにじみ（ピンクとグリーン）をランダムに配置。
ヘッダー（15%）：サービス名を手書き風の柔らかいフォントで#4A3728。「お客様の声をご紹介」を#E8927C で。ロゴエリアを左上に。
顔写真エリア（20%）：丸型の顔写真プレースホルダー。周囲に水彩風のにじみ枠。下に事業者名を手書き風フォントで。
口コミカードエリア（50%）：3枚の白い（#FFFFFF、影付き）カードを少し傾けて重ねて配置。各カードの左上に#E8927C の小さな花や葉のイラスト的装飾。各カード内に★評価と口コミ文の一部。フォントは丸みのあるゴシック。
フッター（15%）：#A7C4A0 の柔らかい帯。サービス概要を#4A3728 で。

【タイポグラフィ】
見出し：丸ゴシック体/手書き風フォント。ジャンプ率15倍。温かみ重視。
本文：丸ゴシック体。行間1.8em。文字間広め。
装飾：引用符を#E8927C の手書き風で大きく配置。`,

    'tpl-004': `
■ビジュアルスタイル：手書きシンプルモノクロ型（シンプルモダン）
コンセプト：墨のペン画＋和紙テクスチャ。ミニマルな線画と余白で「静かな信頼」を演出。美容・和風サービス向け。

【カラーパレット（厳守）】
- 背景色：#F7F3EE（和紙色）
- メイン文字色：#2C2C2C（墨色）
- アクセント色：#C4956A（金茶色）
- サブ色：#8C8C8C（中間グレー）
- ライン色：#2C2C2C（墨色、細い線）

【グリッドシステム】
日本の書道的な縦方向の余白美。中央揃え。要素間に十分な空白。

【レイアウト構成】
背景：#F7F3EE のベースに、和紙のような微細なテクスチャ。
上部余白（10%）：何も配置しない。余白の美。
見出し（10%）：「VOICE」を#C4956A の細い英字フォントで中央配置。下に墨色の細い水平線。
顔写真エリア（15%）：小さめの丸型顔写真プレースホルダー（画像幅の15%）。下に事業者名を細い明朝体風で。
口コミ文エリア（35%）：中央揃え。口コミ文を#2C2C2C の明朝体風フォントで。上下に墨色の細い水平線。行間は文字サイズの2.0倍。
★評価（5%）：★★★★★を#C4956A で控えめに。
サービス情報（10%）：サービス名とロゴを控えめに中央配置。概要を#8C8C8C で小さく。
下部余白（15%）：何も配置しない。余白の美。

【タイポグラフィ】
見出し：細い明朝体。ジャンプ率12倍。エレガンス重視。
本文：明朝体。行間2.0em。文字間やや広め。
装飾：最小限。線と空白で構成。`,

    'tpl-005': `
■ビジュアルスタイル：ビジネス・スタンダード型（ビフォーアフター）
コンセプト：ビジネスプレゼン風の安定感＋Before/Afterの対比で「変化の価値」を視覚化。

【カラーパレット（厳守）】
- 背景色：#FFFFFF（白）
- メイン文字色：#1E293B（ダークネイビー）
- アクセント色：#2563EB（ブルー）
- サブ色：#64748B（スレートグレー）
- Before色：#94A3B8（ライトスレート）
- After色：#2563EB（ブルー）
- カード背景：#F8FAFC

【グリッドシステム】
2カラムの対称グリッド。左右均等分割。中央に区切り。

【レイアウト構成】
ヘッダー（10%）：上部に#2563EB の帯。中に白文字で「お客様の声」と★★★★★。
左カラム（45%）：
  - 上部に「Before」ラベルを#94A3B8 で。
  - 中央に「こんなお悩みありませんか？」の見出しを#64748B で。
  - 薄いグレー（#F1F5F9）の背景。
右カラム（45%）：
  - 上部に「After」ラベルを#2563EB で太く。
  - 中央に口コミ文を#1E293B の太いゴシックで。
  - #F8FAFC の背景に#2563EB の左アクセントライン。
中央分割線：#2563EB の縦線（2px）。その上に顔写真を丸型で大きく配置（画像幅の25%）。下に事業者名。
フッター（10%）：サービス名、ロゴ、サービス概要を#64748B で配置。

【タイポグラフィ】
見出し：ゴシック体Bold。ジャンプ率18倍。
本文：ゴシック体Regular。行間1.7em。
Before/After：異なる太さで対比を明確に。`,

    'tpl-006': `
■ビジュアルスタイル：アイソメトリック・カラー型（信頼のバッジ）
コンセプト：アイソメトリック＋フルカラー＋ゴールドバッジで「格式と信頼の可視化」を実現。士業・医療向け。

【カラーパレット（厳守）】
- 背景色：#0C1220（ディープネイビー）
- メイン文字色：#FFFFFF（白）
- アクセント色1：#D4A853（ゴールド）
- アクセント色2：#3B82F6（ブルー）
- アクセント色3：#10B981（エメラルド）
- バッジ色：#D4A853 のグラデーション

【グリッドシステム】
中央集中型の対称レイアウト。バッジを中心に放射状。

【レイアウト構成】
背景：#0C1220 のソリッド。四隅にアイソメトリック風の幾何学模様（#3B82F6、opacity 10%）。
バッジエリア（30%）：画像上部中央に大きなゴールドの円形エンブレム。エンブレム内に「TRUSTED」の英字。エンブレムの中心にロゴエリア。エンブレム周囲にゴールドの装飾的な放射線。
顔写真エリア（20%）：バッジの直下に丸型顔写真プレースホルダー（画像幅の22%）。#D4A853 の枠線。下に事業者名を#FFFFFF で。
口コミ文エリア（35%）：#FFFFFF の文字で口コミ文を中央揃え。上下に#D4A853 の装飾ライン（水平線＋小さなひし形装飾）。
★評価（5%）：★★★★★を#D4A853 で大きく中央に。
フッター（10%）：サービス名を#D4A853。概要を#CCCCCC で小さく。

【タイポグラフィ】
見出し：Didot / セリフ系の格式高いフォント。ジャンプ率15倍。
本文：ゴシック体。行間1.7em。
ゴールド文字：光沢感のあるグラデーション表現。`,

    'tpl-007': `
■ビジュアルスタイル：雑誌風インタビュー・コラージュ型
コンセプト：ファッション誌やライフスタイル誌のインタビューページ風。モノクロ写真＋赤のアクセント＋上質なタイポグラフィ。

【カラーパレット（厳守）】
- 背景色：#FFFFFF（白）
- メイン文字色：#1A1A1A（ほぼ黒）
- アクセント色：#DC2626（エディトリアルレッド）
- サブ色：#6B7280（グレー）
- 罫線色：#E5E7EB（ライトグレー）
- カード背景：なし（白地に直接）

【グリッドシステム】
雑誌エディトリアルの3カラムグリッド。テキストと写真の大胆な配置。

【レイアウト構成】
ヘッダー帯（6%）：#DC2626 の細い帯。中に「CUSTOMER INTERVIEW」を白の小さなキャピタルレター体で。
左カラム（40%）：
  - 顔写真を大きな正方形で配置（画像幅の38%）。モノクロ処理風プレースホルダー。
  - 写真下に事業者名を#1A1A1A の太いゴシック体で。
  - その下にサービス名を#DC2626 で。
  - 最下部にロゴエリア。
右カラム（55%）：
  - 上部に大きな装飾引用符を#DC2626 で。
  - 口コミ文を#1A1A1A のセリフ体風フォントで。行間2.0em。
  - 口コミ文の前に「Q. サービスを受けていかがでしたか？」を#6B7280 で小さく。
  - 下部に★★★★★を#DC2626 で。
  - 最下部にサービス概要を#6B7280 で。
カラム間に#E5E7EB の細い縦罫線。

【タイポグラフィ】
見出し：Garamond / セリフ系の上品なフォント。ジャンプ率18倍。
本文：明朝体 / セリフ体。行間2.0em。文字間やや広め。
ラベル：小さなキャピタルレター体（英字部分）。`,

    'tpl-008': `
■ビジュアルスタイル：シティポップ・コラージュ型（SNSカジュアル）
コンセプト：80年代シティポップのレトロフューチャー感。フルカラー切り抜きコラージュ＋ネオンカラー＋ポップなタイポグラフィ。

【カラーパレット（厳守）】
- 背景色：#FDF2F8 → #EDE9FE のグラデーション（ピンク→ラベンダー）
- メイン文字色：#1F2937（ダークグレー）
- アクセント色1：#EC4899（ホットピンク）
- アクセント色2：#8B5CF6（パープル）
- アクセント色3：#06B6D4（シアン）
- カード背景：#FFFFFF（白、角丸24px、影付き）

【グリッドシステム】
自由で遊び心のあるレイアウト。要素を少し傾けて配置。

【レイアウト構成】
背景：ピンク→ラベンダーのグラデーション。ランダムに小さな幾何学模様（星、丸、三角）を#FFFFFF opacity 20%で散りばめる。
顔写真エリア（25%）：大きな丸型（画像幅の30%）。#FFFFFF の太い枠線（6px）。全体を3度傾ける。下に事業者名をポップなフォントで#EC4899。
吹き出しカード（45%）：#FFFFFF の大きな吹き出し型カード。角丸24px。ドロップシャドウ。吹き出しの尖りが顔写真を指す。
  カード内上部：★★★★★を#EC4899 で。
  カード内中央：口コミ文を#1F2937 で。ポップな丸ゴシック体。
ハッシュタグ（10%）：「#おすすめ #リピート確定」風のテキストを#8B5CF6 で。
ロゴ・サービス情報（15%）：ロゴエリアとサービス名、概要をカジュアルに配置。
装飾：背景に「LOVE IT!」「RECOMMEND」などの英字をランダムに#FFFFFF opacity 10%で散りばめる。

【タイポグラフィ】
見出し：丸ゴシック体 / ポップ体。ジャンプ率15倍。
本文：丸ゴシック体。行間1.6em。
装飾文字：レトロ風のネオンサイン的表現。`,

    'tpl-009': `
■ビジュアルスタイル：ミニチュア・フォトリアル型（実績数字アピール）
コンセプト：ジオラマ/ミニチュア風のフォトリアルな質感＋巨大な数字で「実績」を圧倒的に可視化。

【カラーパレット（厳守）】
- 背景色：#0F172A（ディープネイビー）
- メイン文字色：#FFFFFF（白）
- アクセント色：#06B6D4（シアン）
- サブ色1：#22D3EE（ライトシアン）
- サブ色2：#164E63（ダークティール）
- カード背景：#FFFFFF
- 数字色：#06B6D4 → #22D3EE のグラデーション

【グリッドシステム】
上下分割の大胆なレイアウト。上部に巨大数字、下部に詳細。

【レイアウト構成】
背景：#0F172A のソリッド。微細なドットパターン（#164E63、opacity 15%）をグリッド状に。
メイン数字エリア（35%）：「★ 4.9」または「満足度 98%」を#06B6D4 → #22D3EE のグラデーション超極太文字で。ジャンプ率30倍。文字に微細な光沢/グロウ効果。下に「お客様満足度」を#FFFFFF で中サイズ。
中央エリア（40%）：
  左側（40%）：顔写真を丸型で（画像幅の22%）。#06B6D4 の枠線。下に事業者名。上にロゴエリア。
  右側（55%）：#FFFFFF の角丸カード。カード内に口コミ文を#1A1A1A で。上部に★★★★★を#06B6D4 で。
フッター（15%）：サービス名を#06B6D4。概要を#94A3B8 で。#06B6D4 の細い水平ライン区切り。
装飾：背景に巨大な「98%」などの数字をゴースト的に#164E63 opacity 8%で配置。

【タイポグラフィ】
数字：超極太ゴシック / Futura Bold風。ジャンプ率30倍。グラデーション。
見出し：太いゴシック体。
本文：ゴシック体Regular。行間1.7em。`,
  };

  const designInstruction = templateDesigns[input.templateId] || templateDesigns['tpl-000'];

  return `あなたはプロフェッショナルなグラフィックデザイナーです。
以下の仕様に厳密に従い、「推薦の声・利用者の声」のポスター画像を1枚生成してください。

■設計思想（この画像の神経科学的な目的）
この画像は以下の4段階で見る人の脳を動かす：
1. Attention（注意喚起）：3秒以内にこの画像が「信頼できるサービスの推薦」であると認識させる
2. Emotion（感情喚起）：「この人のサービスは素晴らしい」という感情を口コミ文で引き起こす
3. Memory（記憶定着）：サービス名・顔写真・★評価の3要素を記憶に刻む
4. Action（行動衝動）：「この人のサービスを受けたい！」と即座に思い、行動したくなる

■コンテンツ情報（すべて画像内に含めること）

【サービス情報】
サービス名：${input.serviceName}
サービス概要：${input.description}
提供内容：${input.whatYouDo}
${input.ownerName ? `事業者名：${input.ownerName}` : ''}

【口コミ文（一字一句正確に。省略・要約は絶対に不可）】
「${input.reviewText}」

【事業者の顔写真】
${input.faceUrl ? '顔写真あり。画像内に事業者の顔写真エリアを必ず目立つ位置に配置。プレースホルダーとして人物のシルエットアイコンを配置。' : '顔写真なし。事業者名のイニシャルを丸型アイコンで表示。'}

【サービスロゴ】
${input.logoUrl ? 'ロゴあり。画像内にロゴエリアを必ず配置。プレースホルダーとして「LOGO」テキストまたはサービス名の頭文字を配置。' : 'ロゴなし。サービス名のテキストで代替。'}

■デザイン指示
${designInstruction}

■共通タイポグラフィ・デザインルール（全テンプレート共通）
1. ジャンプ率（見出しと本文のサイズ差）を指定倍率以上に厳守。見出しは圧倒的に大きく。
2. 本文（口コミ文）は読みやすいフォント。行間は指定倍率以上。
3. 日本語テキストは全て正確に、美しく表示する。文字化けや崩れは絶対に不可。
4. Markdown記号（# * ** など）は一切使わない。一切。
5. カラーパレットは指定色を厳守。背景と文字のコントラスト比は4.5:1以上。
6. 1つの画像＝1つのメッセージ。情報を詰め込みすぎない。

■共通レイアウトルール
1. 向き: ${orientation}
2. 余白：画像端から内側に最低5%のマージン。
3. 要素間の余白を十分に確保し、窮屈にしない。空白は味方。
4. 視線の流れ：上から下へ自然に。最も重要な要素を最も目立つ位置に。

■絶対に守ること
1. 口コミ文を省略・要約しない。全文を画像に含める。
2. サービス名を必ず含める。
3. 事業者の顔写真エリアを必ず配置する（信頼感の源）。
4. ★★★★★の五つ星評価を必ず含める。
5. 「この人のサービスを受けたい」と思わせる訴求力のあるデザイン。
6. 写実的な人物の顔・体は描かない。顔写真エリアはシルエットアイコンまたはイニシャルで代替。
7. テキスト情報は全て正確に表示する。

画像を生成してください。`;
}

/**
 * Generate a review poster image using Gemini 3 Pro Image Preview
 */
export async function generateImageWithGemini(input: ImageGenerationInput): Promise<string> {
  const model = genAI.getGenerativeModel({
    model: 'gemini-3-pro-image-preview',
    generationConfig: {
      // @ts-expect-error - responseModalities is supported but not in types yet
      responseModalities: ['TEXT', 'IMAGE'],
    },
  });

  const prompt = buildPromptForTemplate(input);

  try {
    const result = await model.generateContent([{ text: prompt }]);
    const response = result.response;
    const candidates = response.candidates;

    if (!candidates || candidates.length === 0) {
      throw new Error('画像生成に失敗しました: レスポンスが空です');
    }

    for (const candidate of candidates) {
      if (candidate.content && candidate.content.parts) {
        for (const part of candidate.content.parts) {
          if (part.inlineData && part.inlineData.mimeType?.startsWith('image/')) {
            return `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
          }
        }
      }
    }

    throw new Error('画像生成に失敗しました: 画像データが見つかりません');
  } catch (error) {
    console.error('Gemini image generation error:', error);
    throw error;
  }
}
