import { GoogleGenerativeAI } from '@google/generative-ai';

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || '');

export function isGeminiImageConfigured(): boolean {
  return !!process.env.GEMINI_API_KEY;
}

interface ImageGenerationInput {
  serviceName: string;
  description: string;
  whatYouDo: string;
  ownerName: string | null;
  reviewText: string;
  templateStyle: string;
  templateId: string;
  width: number;
  height: number;
  faceUrl?: string | null;
  logoUrl?: string | null;
}

function buildPromptForTemplate(input: ImageGenerationInput): string {
  const orientation = input.width > input.height ? '横長（landscape）' : '縦長（portrait）';

  // テンプレートIDに基づくデザインスタイル指示
  const templateDesigns: Record<string, string> = {
    'tpl-000': `
デザインスタイル：推薦ポスター型
背景：深い紺色（#1E293B）のソリッドカラー。
ヘッダー領域：画像上部にゴールド（#D4A853）で「この方を推薦します」と極太ゴシック体で大きく配置。文字サイズは画像幅の6%以上。
顔写真エリア：画像左側に、事業者の顔写真を大きな丸型（直径は画像幅の30%程度）で配置。顔写真の周囲にゴールドの細い枠線。顔写真の下に事業者名を白文字で表示。
ロゴエリア：右上にサービスロゴを配置（画像幅の15%程度）。
口コミ文エリア：画像右側に白い角丸カード（#FFFFFF、角丸16px）を配置。カード内に口コミ文を黒文字（#111111）で大きく読みやすく表示。口コミ文の上に大きな装飾的引用符を薄いゴールドで配置。
★評価：口コミカードの下に★★★★★をゴールドで大きく表示。
フッター：画像下部に「どんなサービス？」の小見出しと、サービス概要を白文字で簡潔に1行表示。
全体の印象：権威性・信頼感・プロフェッショナル。見た人が「この人に頼みたい」と思うデザイン。`,

    'tpl-001': `
デザインスタイル：口コミカード型
背景：白（#FFFFFF）をベースに、上部に薄いブルー（#DBEAFE）のグラデーション帯。
ヘッダー：画像上部にサービス名を太いゴシック体で大きく配置（#2563EB）。
ロゴ：サービス名の左横にロゴを配置。
顔写真：画像上部中央に顔写真を大きな丸型で配置（直径は画像幅の25%）。写真の下に事業者名。
口コミ見出し：「お客様の声」を青（#2563EB）で配置。
口コミ文：大きな白いカードの中に口コミ文を黒文字で読みやすく表示。行間を広めに。
★評価：カード上部に★★★★★を黄色で表示。
サービス説明：カード下部に「このサービスについて」として1-2行でサービス概要。
全体の印象：清潔感・誠実さ・親しみやすさ。`,

    'tpl-002': `
デザインスタイル：大見出しインパクト型
背景：黒に近い紺（#0F172A）のソリッド。
メイン見出し：画像上部1/3に「お客様の声」をアンバー（#F59E0B）の超極太文字で配置。画像幅の8%以上の文字サイズ。
顔写真：画像中央左に大きな丸型顔写真（直径は画像幅の28%）。顔写真の下に事業者名を白文字。
ロゴ：顔写真の上にロゴを配置。
口コミ文：画像中央右にクリーム色（#FEF3C7）の角丸ボックス。その中に口コミ文を黒文字で力強く表示。
★評価：口コミボックスの上に★★★★★を大きく。
サービス概要：画像下部にサービス名と「何のサービスか」を白文字で表示。
全体の印象：インパクト・力強さ・説得力。`,

    'tpl-003': `
デザインスタイル：口コミまとめ型
背景：淡いグリーン（#F0FDF4）。
ヘッダー：上部にサービス名を大きく、その下に「お客様の声をご紹介」。
ロゴ：ヘッダー左にロゴ配置。
顔写真：ヘッダー右に顔写真を丸型で配置。横に事業者名。
口コミカード：縦に3枚の白いカードを並べる。各カードの左端にグリーン（#16A34A）のアクセントライン。各カード内に★評価と口コミ文（同じ口コミ文を3つの視点で分割しても良い）。
サービス説明：最下部にサービス概要を1行で。
全体の印象：信頼感・実績・安心感。複数の声で説得力を出す。`,

    'tpl-004': `
デザインスタイル：シンプルモダン型
背景：オフホワイト（#FAFAF9）。
装飾：上部に「VOICE」の英字を薄いゴールド（#A16207、opacity 20%）で大きく背景装飾。
顔写真：画像上部に小さめの丸型顔写真。下に事業者名を細い上品なフォントで。
ロゴ：顔写真の下にロゴを控えめに配置。
口コミ文：画像中央に口コミ文を上品なフォントで中央揃え。上下に細い水平線で区切り。
★評価：口コミ文の上に★を控えめに。
サービス名：下部にサービス名を控えめに。
全体の印象：洗練・エレガント・高級感。美容サロン向け。`,

    'tpl-005': `
デザインスタイル：ビフォーアフター型
背景：左半分がグレー（#E5E7EB）、右半分が薄い紫（#EDE9FE）の2分割。
左側：「Before」ラベルをグレー文字で。「こんなお悩みありませんか？」の小見出し。
右側：「After」ラベルを紫（#7C3AED）で。解決後の喜びの口コミ文を紫の角丸カード内に白文字で。
中央：2分割の境界線上に顔写真を大きな丸型で配置。
ロゴ：右下にロゴ。
★評価：右側のカード下に★★★★★。
サービス名：画像下部にサービス名と概要。
全体の印象：変化・成長・希望。整体・美容・教育系向け。`,

    'tpl-006': `
デザインスタイル：信頼のバッジ型
背景：深いネイビー（#0F172A）。
バッジ：画像上部中央に大きなゴールド（#D4A853）のエンブレム/バッジデザイン。バッジ内に「TRUSTED」の文字。バッジの中にロゴがあればロゴを配置。
顔写真：バッジの下に顔写真を丸型で配置。写真の下に事業者名を白文字。
口コミ文：画像下半分に白文字で口コミ文を格調高く配置。上下にゴールドの装飾ライン。
★評価：口コミ文の上に★★★★★をゴールドで。
サービス概要：最下部にサービス名と概要を小さめの白文字で。
全体の印象：権威・格式・最高級の信頼感。士業・医療・コンサル向け。`,

    'tpl-007': `
デザインスタイル：雑誌風インタビュー型
背景：白（#FFFFFF）。
ヘッダー：上部に赤（#DC2626）の細い帯。帯の中に白文字で「CUSTOMER INTERVIEW」。
レイアウト：左右2カラム。
左カラム：顔写真を大きな正方形で配置（画像幅の40%）。写真の下に事業者名とサービス名。ロゴも左下に配置。
右カラム：口コミ文を対話形式風に配置。Q「サービスを受けていかがでしたか？」→ A（口コミ文）の形式。テキストは黒文字で読みやすく。
★評価：右カラム上部に★★★★★。
サービス概要：右カラム下部にサービス概要を1-2行で。
全体の印象：知的・洗練・信頼。雑誌のインタビューページのような上質さ。`,

    'tpl-008': `
デザインスタイル：SNS風カジュアル型
背景：パステルピンク→パープルのグラデーション（#FDF2F8→#F3E8FF）。
顔写真：画像上部中央に大きな丸型顔写真（直径は画像幅の30%）。写真の周囲に白い太めの枠。
事業者名：顔写真の下にカジュアルなフォントで事業者名。
口コミ文：大きな白い吹き出し型のボックスに口コミ文をカジュアルなフォントで。吹き出しの尖りが顔写真を指す。
ロゴ：吹き出しの下にロゴ。
ハッシュタグ：吹き出しの下に「#おすすめ #リピート確定 #◯◯好きと繋がりたい」風のテキスト（ピンク文字）。
★評価：吹き出し内上部に★★★★★。
サービス概要：最下部にサービス名と概要をカジュアルに。
全体の印象：親しみ・ポップ・若々しさ。Instagram投稿風。`,

    'tpl-009': `
デザインスタイル：実績数字アピール型
背景：深いティール（#0F172A）。
メイン数字：画像上部に「★ 4.9」や「満足度 98%」のような大きなインパクト数字をシアン（#06B6D4）の超極太文字で。画像幅の10%以上の文字サイズ。
サブ見出し：数字の下に「お客様満足度」を白文字で。
顔写真：画像中央左に丸型顔写真。下に事業者名。
ロゴ：顔写真の上にロゴ。
口コミ文：画像中央右に白い角丸カードで口コミ文を黒文字で表示。
★評価：口コミカードの上に★★★★★。
サービス概要：画像下部にサービス名と概要を白文字で。
全体の印象：データドリブン・説得力・信頼の可視化。`,
  };

  const designInstruction = templateDesigns[input.templateId] || templateDesigns['tpl-000'];

  return `あなたはプロフェッショナルなグラフィックデザイナーです。
以下の仕様に厳密に従い、「推薦の声・利用者の声」のポスター画像を1枚生成してください。

この画像の目的：この画像を見た人が「この人のサービスを受けたい！」と即座に思い、行動したくなること。

【サービス情報（必ず画像に含める）】
サービス名：${input.serviceName}
サービス概要：${input.description}
提供内容：${input.whatYouDo}
${input.ownerName ? `事業者名：${input.ownerName}` : ''}

【口コミ文（必ず画像に含める。一字一句正確に）】
「${input.reviewText}」

【事業者の顔写真について】
${input.faceUrl ? '顔写真あり。画像内に事業者の顔写真エリア（丸型または正方形）を必ず目立つ位置に配置すること。顔写真エリアにはプレースホルダーとして人物のシルエットアイコンを配置。' : '顔写真なし。顔写真エリアの代わりに事業者名のイニシャルを丸型アイコンで表示。'}

【サービスロゴについて】
${input.logoUrl ? 'ロゴあり。画像内にロゴエリアを必ず配置すること。ロゴエリアにはプレースホルダーとして「LOGO」テキストまたはサービス名の頭文字を配置。' : 'ロゴなし。サービス名のテキストで代替。'}

${designInstruction}

【タイポグラフィ・デザインルール】
1. 見出し文字は極太ゴシック体。本文の3倍以上のサイズ差（ジャンプ率を死守）。
2. 本文（口コミ文）は読みやすいゴシック体。行間は文字サイズの1.6倍以上。
3. 日本語テキストは全て正確に、美しく表示する。文字化けや崩れは絶対に不可。
4. Markdown記号（# * ** など）は一切使わない。
5. カラーパレットは指定色を厳守。背景と文字のコントラスト比は4.5:1以上。

【レイアウトルール】
1. 向き: ${orientation}
2. 余白：画像端から内側に最低5%のマージン。
3. 要素間の余白を十分に確保し、窮屈にしない。
4. 視線の流れ：上から下へ自然に。最も重要な要素（口コミ文）を最も目立つ位置に。

【絶対に守ること】
1. 口コミ文を省略・要約しない。全文を画像に含める。
2. サービス名を必ず含める。
3. 事業者の顔写真エリアを必ず配置する（信頼感の源）。
4. ★★★★★の五つ星評価を必ず含める。
5. 「この人のサービスを受けたい」と思わせる訴求力のあるデザイン。
6. 写実的な人物の顔・体は描かない。顔写真エリアはシルエットアイコンまたはイニシャルで代替。

画像を生成してください。`;
}

/**
 * Generate a review poster image using Gemini 3 Pro Image Preview
 */
export async function generateImageWithGemini(input: ImageGenerationInput): Promise<string> {
  const model = genAI.getGenerativeModel({
    model: 'gemini-3-pro-image-preview',
    generationConfig: {
      // @ts-expect-error - responseModalities is supported but not in types yet
      responseModalities: ['TEXT', 'IMAGE'],
    },
  });

  const prompt = buildPromptForTemplate(input);

  try {
    const result = await model.generateContent([{ text: prompt }]);
    const response = result.response;
    const candidates = response.candidates;

    if (!candidates || candidates.length === 0) {
      throw new Error('画像生成に失敗しました: レスポンスが空です');
    }

    for (const candidate of candidates) {
      if (candidate.content && candidate.content.parts) {
        for (const part of candidate.content.parts) {
          if (part.inlineData && part.inlineData.mimeType?.startsWith('image/')) {
            return `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
          }
        }
      }
    }

    throw new Error('画像生成に失敗しました: 画像データが見つかりません');
  } catch (error) {
    console.error('Gemini image generation error:', error);
    throw error;
  }
}
